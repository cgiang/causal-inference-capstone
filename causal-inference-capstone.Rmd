---
title: "What is the causal effect of sleeping time on life satisfaction?"
author: "Charlotte Giang, Yunyang Zhong"
date: "10/11/2020"
output: html_document
---

# Loading data

```{r,eval=TRUE, warning=FALSE, message=FALSE}
library(ipumsr)
ddi <- read_ipums_ddi("atus_00001.xml")
data <- read_ipums_micro(ddi)
library(dplyr) 
data <- select(data, WT06, SPOUSEPRES, SPEDUC, SPEMPSTAT, Sleeping_time, Traveling, FAMINCOME, WBLADDER, WBELIGTIME, caring_HH_adults)
data <- data %>%
  filter(!is.na(WBLADDER)) %>%
  filter(WBLADDER > -1 & WBLADDER < 11) %>%
  filter(SPEDUC < 44) %>%
  filter(SPEMPSTAT < 7)
data$WBLADDER = as.numeric(data$WBLADDER)
data$WT06 = as.numeric(data$WT06)
```

<br><br>

# Causal discovery 

```{r, echo=FALSE, message=FALSE, eval=FALSE}
library(dagitty)
dag <- dagitty("dag {
bb=\"0,0,1,1\"
\"# of partners\" [pos=\"0.321,0.503\"]
\"education of partners\" [pos=\"0.666,0.214\"]
\"elderly care\" [pos=\"0.821,0.673\"]
\"employment status of partners\" [pos=\"0.393,0.208\"]
\"family income\" [latent,pos=\"0.495,0.350\"]
\"life satisfaction\" [outcome,pos=\"0.740,0.832\"]
\"well-being\" [pos=\"0.476,0.713\"]
\"sleep\" [exposure,pos=\"0.281,0.835\"]
\"travel\" [pos=\"0.726,0.433\"]
\"weight\" [pos=\"0.200,0.604\"]
\"# of partners\" -> \"elderly care\"
\"# of partners\" -> \"employment status of partners\"
\"# of partners\" -> \"family income\"
\"# of partners\" -> \"travel\"
\"education of partners\" -> \"employment status of partners\"
\"education of partners\" -> \"family income\"
\"employment status of partners\" -> \"family income\"
\"family income\" -> \"elderly care\"
\"family income\" -> \"life satisfaction\"
\"family income\" -> \"sleep\"
\"family income\" -> \"travel\"
\"life satisfaction\" -> \"# of partners\"
\"life satisfaction\" -> \"well-being\"
\"well-being\" -> \"weight\"
\"sleep\" -> \"# of partners\"
\"sleep\" -> \"life satisfaction\"
\"sleep\" -> \"well-being\"
\"travel\" -> \"life satisfaction\"
\"weight\" -> \"sleep\"
}
")
plot(dag)
```

> The total effect cannot be estimated by covariate adjustment.

> The direct effect cannot be estimated by covariate adjustment.

```{r, message = FALSE}
library(pcalg)

suff_stat <- list(C = cor(data), n = nrow(data))
pc_data <- pc(suff_stat, indepTest = gaussCItest, labels = colnames(data), alpha = 0.01, skel.method = "stable.fast")

plot(pc_data, main = "")
```

<br><br>

# Subject knowledge causal graph

```{r}
# Convert variable type -- run AFTER using pcalg package
data$SPOUSEPRES = as.factor(data$SPOUSEPRES)
data$SPEDUC = as.factor(data$SPEDUC)
data$SPEMPSTAT = as.factor(data$SPEMPSTAT)
```


```{r}
summary(data)
```


![](dag2.png)

> Adjustment, total effect: Family income, Spouse or unmarried partner in household

> Adjustment, direct effect: Family income, Person weight, Spouse or unmarried partner in household, Well-being

```{r, echo=FALSE, message=FALSE, eval=FALSE}
library(dagitty)
dag <- dagitty("dag {
bb=\"0,0,1,1\"
\"Employment status (spouse or partner)\" [pos=\"-0.4,0.3\"]
\"Family income\" [pos=\"-0.307,0.522\"]
\"Highest level of school completed (spouse or partner)\" [pos=\"-0.122,0.392\"]
\"Household elderly care\" [pos=\"0.137,0.841\"]
\"Life satisfaction\" [outcome,pos=\"-0.112,1.103\"]
\"Person weight\" [pos=\"-1.014,0.756\"]
\"Spouse or unmarried partner in household\" [pos=\"-0.801,0.599\"]
\"Traveling time\" [pos=\"-0.001,0.596\"]
\"Well-being\" [pos=\"-0.584,1.012\"]
\"Sleeping_time\" [exposure,pos=\"-1.108,1.101\"]
\"Employment status (spouse or partner)\" -> \"Family income\"
\"Family income\" -> \"Household elderly care\"
\"Family income\" -> \"Life satisfaction\"
\"Family income\" -> \"Traveling time\"
\"Family income\" -> \"Sleeping_time\"
\"Highest level of school completed (spouse or partner)\" -> \"Employment status (spouse or partner)\"
\"Highest level of school completed (spouse or partner)\" -> \"Family income\"
\"Household elderly care\" -> \"Life satisfaction\"
\"Household elderly care\" -> \"Traveling time\"
\"Person weight\" -> \"Life satisfaction\"
\"Person weight\" -> \"Well-being\"
\"Spouse or unmarried partner in household\" -> \"Employment status (spouse or partner)\"
\"Spouse or unmarried partner in household\" -> \"Family income\"
\"Spouse or unmarried partner in household\" -> \"Household elderly care\"
\"Spouse or unmarried partner in household\" -> \"Life satisfaction\"
\"Spouse or unmarried partner in household\" -> \"Traveling time\"
\"Spouse or unmarried partner in household\" -> \"Sleeping_time\"
\"Traveling time\" -> \"Life satisfaction\"
\"Well-being\" -> \"Life satisfaction\"
\"Sleeping_time\" -> \"Life satisfaction\"
\"Sleeping_time\" -> \"Person weight\"
\"Sleeping_time\" -> \"Well-being\"
}
")
plot(dag)
```

<br><br>

# Exploratory data analysis

```{r}
library(ggplot2)
ggplot(data=data,aes(x=Sleeping_time,y=WBLADDER))+geom_point()+geom_smooth()
```



```{r}
ggplot(data=data,aes(x=Sleeping_time,y=WBLADDER,color=factor(SPOUSEPRES)))+geom_point()+geom_smooth()
```

```{r}
# Alternatively
ggplot(data, aes(x = Sleeping_time, y = WBLADDER)) +
    geom_boxplot() +
    facet_grid(~SPOUSEPRES) 
```

```{r}
library(splines)
ggplot(data, aes(y = SPOUSEPRES, x = Sleeping_time)) +
    geom_point() +
    geom_smooth(se = FALSE, color = "blue") +
    geom_smooth(formula = y~ns(x,2), method = "glm",
        method.args = list(family="binomial"),
        se = FALSE, color = "red"
    )

ggplot(data, aes(y = WT06, x = Sleeping_time)) +
    geom_point() +
    geom_smooth(se = FALSE, color = "blue") +
    geom_smooth(formula = y~ns(x,2), method = "glm",
        method.args = list(family="binomial"),
        se = FALSE, color = "red"
    )
```



```{r, message=FALSE}
mod1 <- lm(WBLADDER~Sleeping_time, data = data)
summary(mod1)

mod2 <- lm(WBELIGTIME~WT06, data = data)
summary(mod2)
```

```{r}
mod3 <- lm(WBLADDER~caring_HH_adults, data = data)
summary(mod3)

mod4 <- lm(WBLADDER~WT06, data = data)
summary(mod4)
```

```{r, message=FALSE}
mod5 <- lm(Sleeping_time~WT06, data = data)
summary(mod5)

mod6 <- lm(WBLADDER~SPOUSEPRES, data = data)
summary(mod6)

mod7 <- lm(Sleeping_time~SPOUSEPRES, data = data)
summary(mod7)

mod8 <- lm(WBLADDER~WBELIGTIME, data = data)
summary(mod8)

mod9 <- lm(Sleeping_time~WBELIGTIME, data = data)
summary(mod9)

mod10 <- lm(WBLADDER~Traveling, data = data)
summary(mod10)
```

```{r}
mod11 <- lm(Traveling~caring_HH_adults, data = data)
summary(mod11)
```

```{r}
mod12 <- glm(SPOUSEPRES~caring_HH_adults, family = "binomial", data = data)
summary(mod12)

mod13 <- glm(SPOUSEPRES~Traveling, family = "binomial", data = data)
summary(mod13)

mod14 <- glm(SPOUSEPRES~SPEMPSTAT, family = "binomial", data = data)
summary(mod14)

mod15 <- glm(SPEDUC~SPEMPSTAT, , family = "binomial", data = data)
summary(mod15)
```

> All associations in the dagitty graph above are checked. Except insignificant associations between life satisfaction and weight, life satisfaction and elderly care, and traveling and elderly care, the rest are all strong associations.

```{r}
mod16 <- lm(WBLADDER~Sleeping_time+WBELIGTIME, data = data)
summary(mod16)

mod17 <- lm(WT06~Sleeping_time+WBELIGTIME, data = data)
summary(mod17)
```

> From model 16, controlling for well-being makes sleep and life satisfaction a strong association. Therefore, well-being must be a collider. From model 17, controlling for well-being makes sleep and weight a weak association. Therefore, neither well-being nor weight can be a collider in this set and thus well-being must point to weight and weight must point to sleep.

```{r}
mod18 <- lm(WBLADDER~Sleeping_time+SPOUSEPRES, data = data)
summary(mod18)
```

> From model 18, controlling for number of partners makes sleep and life satisfaction a strong association. Therefore, number of partners must be a collider.

![](dagitty-model.png)

<br><br>

# Mediation analysis


